<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registrar Nuevo Socio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="/static/js/api.js"></script>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
  <header class="p-4 border-b border-slate-800 flex items-center justify-between">
    <h1 class="text-xl font-semibold">ü¶æ Panel de Recepci√≥n</h1>
    <nav class="space-x-3 text-sm">
      <a href="/" class="hover:underline">Logs</a>
      <a href="/registro" class="underline">Registrar Usuario</a>
      <a href="/eliminar" class="hover:underline">Eliminar Usuario</a>
    </nav>
  </header>

  <main class="max-w-3xl mx-auto p-6">
    <div class="bg-slate-800/70 border border-slate-700 rounded-2xl p-6">
      <h2 class="text-xl font-semibold mb-6">Registrar Nuevo Socio</h2>
      <form id="f" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1">Nombre</label>
          <input id="nombre" class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg" placeholder="Ej: Juan" required />
        </div>
        <div>
          <label class="block text-sm mb-1">Apellido</label>
          <input id="apellido" class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg" placeholder="Ej: P√©rez" required />
        </div>
        <div>
          <label class="block text-sm mb-1">DNI</label>
          <input id="dni" type="number" class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg" placeholder="Ej: 40123456" required />
        </div>
        <div>
          <label class="block text-sm mb-1">Fecha de Nacimiento</label>
          <input id="nacimiento" type="date" class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg" required />
        </div>
        <div>
          <label class="block text-sm mb-1">Tel√©fono</label>
          <input id="telefono" class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg" placeholder="Ej: 1123456789" />
        </div>
        <div>
          <label class="block text-sm mb-1">Email</label>
          <input id="mail" type="email" class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg" placeholder="Ej: ejemplo@mail.com" />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Plan</label>
          <select id="plan" class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg"></select>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">(Opcional) Embedding Facial 512 valores separados por coma</label>
          <textarea id="embedding" class="w-full h-24 px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg" placeholder="v1, v2, v3, ..."></textarea>
          <p class="text-xs text-slate-400 mt-1">Si dej√°s esto vac√≠o, el socio quedar√° sin rostro hasta que el servicio de reconocimiento lo cargue.</p>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Video para generar embedding (15 capturas)</label>
          <input id="video" type="file" accept="video/*" class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg" />
          <p class="text-xs text-slate-400 mt-1">El video se procesa para extraer 15 capturas, calcular el embedding y luego se eliminan las capturas para ahorrar espacio.</p>
        </div>
        <div class="md:col-span-2 flex justify-end gap-2 mt-2">
          <a href="/" class="px-4 py-2 rounded-lg bg-slate-700">Cancelar</a>
          <button class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500">Guardar</button>
        </div>
      </form>
    </div>
  </main>

  <script>
    window.addEventListener('DOMContentLoaded', async () => {
      // Asegurarse de que API est√© disponible. Si no, intentar cargar din√°micamente.
      if (typeof API !== 'function') {
        try {
          await new Promise((res, rej) => {
            const s = document.createElement('script');
            s.src = '/static/js/api.js';
            s.async = false;
            s.onload = res;
            s.onerror = rej;
            document.head.appendChild(s);
          });
        } catch (err) {
          console.error('No se pudo cargar /static/js/api.js:', err);
        }
      }
      if (typeof API !== 'function') {
        console.error('API no est√° definida tras intentar cargar api.js. Comprueba la ruta y que el servidor sirve archivos est√°ticos.');
        return;
      }

      const api = API();

      async function loadPlanes() {
        const planes = await api.planes();
        const sel = document.getElementById('plan');
        sel.innerHTML = '';
        planes.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id_plan;
          opt.textContent = p.nombre;
          sel.appendChild(opt);
        });
      }
      await loadPlanes();

      document.getElementById('f').addEventListener('submit', async (e) => {
        e.preventDefault();
        const embText = (document.getElementById('embedding') || { value: '' }).value.trim();
        let embedding = null;
        if (embText) {
          embedding = embText.split(',').map(x => parseFloat(x.trim())).filter(x => !Number.isNaN(x));
          if (embedding.length !== 512) {
            alert('El embedding debe tener 512 valores.');
            return;
          }
        }
        const dniValue = parseInt(document.getElementById('dni').value, 10);
        const payload = {
          dni: dniValue,
          nombre: document.getElementById('nombre').value,
          apellido: document.getElementById('apellido').value,
          fecha_nacimiento: document.getElementById('nacimiento').value,
          telefono: document.getElementById('telefono').value || null,
          mail: document.getElementById('mail').value || null,
          id_plan: parseInt(document.getElementById('plan').value, 10),
          dias_duracion: 30,
          embedding: embedding
        };
        const videoInput = document.getElementById('video');
        const videoFile = videoInput && videoInput.files && videoInput.files.length ? videoInput.files[0] : null;
        try {
          await api.altaSocio(payload);
          let message = 'Socio creado con √©xito';
          if (videoFile) {
            try {
              await api.rostroDesdeVideo(dniValue, videoFile);
              message = 'Socio creado y embedding generado con √©xito';
            } catch (err) {
              console.error(err);
              alert('Socio creado, pero no se pudo generar el embedding desde el video. Pod√©s intentarlo nuevamente desde esta p√°gina.');
              return;
            }
          }
          alert(message);
          window.location.href = '/';
        } catch (err) {
          alert('Error al crear socio');
          console.error(err);
        }
      });
    });
  </script>
</body>
</html>
